name: Deploy to DigitalOcean Droplet

on:
  push:
    branches:
      - main
      - test

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.21.1'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install

      - name: Run tests
        run: pnpm test

      - name: Debug Secrets
        run: |
          echo "DROPLET_IP is set: ${{ secrets.DROPLET_IP != '' }}"
          echo "DROPLET_USER is set: ${{ secrets.DROPLET_USER != '' }}"
          echo "DROPLET_PASSWORD is set: ${{ secrets.DROPLET_PASSWORD != '' }}"

      - name: Deploy to DigitalOcean Droplet
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: ${{ secrets.DROPLET_USER }}
          password: ${{ secrets.DROPLET_PASSWORD }}
          script: |
            echo "Connected to Droplet"
            echo "ğŸ” Checking disk usage before cleanup..."
            df -h

            echo "ğŸ§¹ Cleaning up disk space..."

            # Clean pnpm cache
            echo "ğŸ“¦ Cleaning pnpm cache..."
            pnpm store prune || true
            rm -rf ~/.pnpm-store/* || true

            # Clean PM2 logs
            echo "ğŸ“‹ Cleaning PM2 logs..."
            pm2 flush || true
            rm -rf ~/.pm2/logs/*.log || true

            # Clean temporary files
            echo "ğŸ§¹ Cleaning temporary files..."
            rm -rf /tmp/* || true
            rm -rf /var/tmp/* || true

            echo "âœ… Cleanup complete!"
            echo "ğŸ“Š Disk usage after cleanup:"
            df -h

            # Create app directory if it doesn't exist
            mkdir -p ~/in-process-token-indexer
            cd ~/in-process-token-indexer

            # Clean git objects before operations
            echo "ğŸ“š Cleaning git objects..."
            if [ -d .git ]; then
              git gc --prune=now --aggressive || true
            fi

            # Initialize git repository if it doesn't exist
            if [ ! -d .git ]; then
              git init
              git remote add origin https://github.com/SweetmanTech/in-process-token-indexer.git
            fi

            # Fetch latest code and handle local changes
            git fetch --all
            git checkout -B ${{ github.ref_name }} origin/${{ github.ref_name }}
            git reset HEAD --hard
            git pull origin ${{ github.ref_name }}

            echo "Current branch:"
            git branch --show-current
            echo "Git status:"
            git status

            # Remove old node_modules to free space before install
            echo "ğŸ—‘ï¸  Removing old node_modules..."
            rm -rf node_modules || true

            # Install nvm if not available
            echo "ğŸ“¦ Checking nvm installation..."
            if [ ! -s "$HOME/.nvm/nvm.sh" ]; then
              echo "ğŸ“¦ Installing nvm..."
              curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
            fi

            # Source nvm
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

            # Install Node.js 22.21.1 using nvm if not available
            echo "ğŸ“¦ Checking Node.js version..."
            if ! command -v node &> /dev/null; then
              echo "ğŸ“¦ Node.js not found. Installing Node.js 22.21.1 using nvm..."
              nvm install 22.21.1
              nvm use 22.21.1
              nvm alias default 22.21.1
            else
              CURRENT_VERSION=$(node -v)
              if [ "$CURRENT_VERSION" != "v22.21.1" ]; then
                echo "ğŸ“¦ Node.js version is $CURRENT_VERSION. Installing Node.js 22.21.1 using nvm..."
                nvm install 22.21.1
                nvm use 22.21.1
                nvm alias default 22.21.1
              else
                echo "âœ… Node.js 22.21.1 is already installed"
                nvm use 22.21.1
              fi
            fi
            echo "ğŸ“Š Node.js version:"
            node -v
            echo "ğŸ“Š npm version:"
            npm -v

            # Install pnpm if not available
            if ! command -v pnpm &> /dev/null; then
              echo "ğŸ“¦ Installing pnpm..."
              npm install -g pnpm@8
            fi

            # Install dependencies
            pnpm install

            # Build the application
            echo "ğŸ”¨ Building application..."
            pnpm run build

            # Check build result
            BUILD_EXIT_CODE=$?
            if [ $BUILD_EXIT_CODE -ne 0 ]; then
              echo "âŒ Build failed with exit code $BUILD_EXIT_CODE"
              exit 1
            fi

            # Verify build output exists
            echo "âœ… Verifying build output..."
            if [ ! -d dist ]; then
              echo "âŒ Build failed: dist directory not found"
              exit 1
            fi

            # Check if main entry point exists
            if [ ! -f dist/indexer.js ]; then
              echo "âŒ Build failed: dist/indexer.js not found"
              exit 1
            fi

            echo "âœ… Build verification complete"
            echo "ğŸ“Š Build output size:"
            du -sh dist || true
            echo "ğŸ“ Build output contents:"
            ls -lah dist/ | head -20 || true

            # Restart the application
            pm2 restart ecosystem.config.cjs --update-env
