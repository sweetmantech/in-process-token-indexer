---
alwaysApply: true
---

# Envio Indexer Reference

This project maps data from **Envio GraphQL DB** to **Supabase**. The Envio indexer that populates the GraphQL database is located at:

**Reference Project**: `/home/kcethdev/Documents/GitHub/in_process_indexers`

## Envio Indexer Project Structure

### GraphQL Schema Entities

The Envio indexer defines these entities in `schema.graphql`:

- `InProcess_Collections` - Collection/contract metadata
- `InProcess_Moments` - Token/moment data
- `InProcess_Sales` - Sale configuration data
- `InProcess_Admins` - Admin permissions for moments
- `InProcess_Moment_Comments` - Comments on moments
- `InProcess_Payments` - Payment/reward deposits

## Complete GraphQL Schema

```graphql

type InProcess_Collections {
  id: ID!
  address: String!
  name: String!
  uri: String!
  default_admin: String!
  payout_recipient: String!
  chain_id: Int!
  created_at: Int!
  updated_at: Int!
  transaction_hash: String!
}

type InProcess_Moments {
  id: ID!
  collection: String!
  token_id: Int!
  uri: String!
  max_supply: BigInt!
  chain_id: Int!
  created_at: Int!
  updated_at: Int!
  transaction_hash: String!
}

type InProcess_Sales {
  id: ID!
  collection: String!
  token_id: Int!
  sale_start: BigInt!
  sale_end: BigInt!
  max_tokens_per_address: BigInt!
  price_per_token: BigInt!
  funds_recipient: String!
  currency: String!
  chain_id: Int!
  transaction_hash: String!
  created_at: Int!
}

type InProcess_Admins {
  id: ID!
  admin: String!
  collection: String!
  token_id: Int!
  chain_id: Int!
  permission: Int!
  granted_at: Int!
  updated_at: Int!
}

type InProcess_Moment_Comments {
  id: ID!
  collection: String!
  sender: String!
  token_id: Int!
  comment: String
  chain_id: Int!
  commented_at: Int!
  transaction_hash: String!
}

type InProcess_Payments {
  id: ID!
  collection: String!
  currency: String!
  token_id: Int!
  recipient: String!
  spender: String!
  amount: String!
  chain_id: Int!
  transaction_hash: String!
  transferred_at: Int!
}


```

## TypeScript Type Definitions

These types are generated from the schema and used in the Envio indexer handlers:

```typescript
export type InProcess_Collections_t = {
  readonly address: string;
  readonly chain_id: number;
  readonly created_at: number;
  readonly default_admin: string;
  readonly id: string;
  readonly name: string;
  readonly payout_recipient: string;
  readonly transaction_hash: string;
  readonly updated_at: number;
  readonly uri: string;
};

export type InProcess_Moments_t = {
  readonly chain_id: number;
  readonly collection: string;
  readonly created_at: number;
  readonly id: string;
  readonly max_supply: bigint;
  readonly token_id: number;
  readonly transaction_hash: string;
  readonly updated_at: number;
  readonly uri: string;
};

export type InProcess_Sales_t = {
  readonly chain_id: number;
  readonly collection: string;
  readonly created_at: number;
  readonly currency: string;
  readonly funds_recipient: string;
  readonly id: string;
  readonly max_tokens_per_address: bigint;
  readonly price_per_token: bigint;
  readonly sale_end: bigint;
  readonly sale_start: bigint;
  readonly token_id: number;
  readonly transaction_hash: string;
};

export type InProcess_Admins_t = {
  readonly id: string;
  readonly admin: string;
  readonly collection: string;
  readonly token_id: number;
  readonly chain_id: number;
  readonly permission: number;
  readonly updated_at: number;
};

export type InProcess_Moment_Comments_t = {
  readonly chain_id: number;
  readonly collection: string;
  readonly comment: string | undefined;
  readonly commented_at: number;
  readonly id: string;
  readonly sender: string;
  readonly token_id: number;
  readonly transaction_hash: string;
};

export type InProcess_Payments_t = {
  readonly id: string;
  readonly collection: string;
  readonly currency: string;
  readonly token_id: number;
  readonly recipient: string;
  readonly spender: string;
  readonly amount: string;
  readonly chain_id: number;
  readonly transaction_hash: string;
  readonly transferred_at: number;
};
```

**Note**: When querying GraphQL, BigInt fields (like `max_supply`, `sale_start`, etc.) are returned as strings. The TypeScript types use `bigint` for internal representation in the indexer, but GraphQL queries will return them as strings.

### Key Files in Reference Project

- `schema.graphql` - GraphQL schema definitions
- `config.yaml` - Envio indexer configuration (contracts, events, networks)
- `src/EventHandlers.ts` - Main event handler registration
- `src/handlers/` - Individual event handlers for each entity type
- `lib/` - Utility functions (formatUnits, getUsdcTransfer, validation helpers, viem clients)

### Event Handlers Pattern

Handlers in the reference project follow this pattern:
```typescript
ContractName.EventName.handler(async ({ event, context }) => {
  const entity: EntityType = {
    // Map event data to entity
  };
  context.EntityType.set(entity);
});
```

## Querying Envio GraphQL

When querying the Envio GraphQL endpoint:

1. **Entity Naming**: Use the exact entity names from `schema.graphql` (e.g., `InProcess_Collections`, `InProcess_Moments`)
2. **Field Names**: Use snake_case field names as defined in the schema (e.g., `chain_id`, `token_id`, `created_at`)
3. **GraphQL Endpoint**: Typically `http://localhost:8080/graphql` for local development

### Example Query Pattern

```graphql
query MyQuery($limit: Int, $offset: Int, $chainId: Int) {
  InProcess_Collections(
    limit: $limit
    offset: $offset
    order_by: { created_at: desc }
    where: { chain_id: { _eq: $chainId } }
  ) {
    id
    address
    name
    uri
    default_admin
    payout_recipient
    chain_id
    created_at
    updated_at
    transaction_hash
  }
}
```

## Development Guidelines

### DO:
- ✅ Query Envio GraphQL entities using the exact names from `schema.graphql`
- ✅ Use snake_case for field names when querying
- ✅ Reference the handler files in `/home/kcethdev/Documents/GitHub/in_process_indexers/src/handlers/` to understand data structure
- ✅ Check `lib/` utilities in the reference project for helper functions
- ✅ Map Envio entities to Supabase tables appropriately

### DON'T:
- ❌ **DO NOT** touch or modify files in the `legacy/` directory
- ❌ **DO NOT** reference legacy code patterns - they use old naming conventions
- ❌ **DO NOT** use old entity names like `ERC20Minter_ERC20RewardsDeposit` or `InProcess_ERC20RewardsDeposit` (use `InProcess_Payments` instead)
- ❌ **DO NOT** use old field names like `blockNumber` (use `block_number` from schema)

## Networks

The Envio indexer supports these networks (from `config.yaml`):
- **84532** (Base Sepolia) - start_block: 23208989
- **8453** (Base Mainnet) - start_block: 27712746

## Mapping to Supabase

When syncing data to Supabase:
- Map Envio GraphQL entities to corresponding Supabase tables
- Handle field name conversions (snake_case is standard in both)
- Ensure proper data type conversions (BigInt → string, timestamps, etc.)
- Implement proper error handling and retry logic

## Architecture Notes

- The `legacy/` directory will be removed after completing the new architecture
- Focus on building new code in the `lib/` directory (currently empty)
- The new architecture should be cleaner and directly query Envio GraphQL entities
